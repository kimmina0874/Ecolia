<!DOCTYPE html>
<html>
<head>
	<title>Ecolia + Minimap</title>
	<style>
		body {
			margin: 0;
			padding: 0;
			height: 100%;
			font-family: sans-serif;
			display: flex;
			flex-direction: column;
			align-items: center;
			background: #f5f6fa;
		}
		h1 {
			margin: 10px 0 5px;
		}
		.controls {
			display: flex;
			gap: 10px;
			margin-bottom: 10px;
		}
		button {
			padding: 6px 12px;
			border-radius: 6px;
			border: 1px solid #ccc;
			background: #ecf0f1;
			cursor: pointer;
		}
		button:hover {
			background-color: #dcdde1;
		}
		.map-container {
			flex: 1;
			width: 100%;
			position: relative;
			display: flex;
			justify-content: center;
			align-items: center;
		}
		svg {
			width: 90vw;
			height: auto;
			max-height: 80vh;
			border: 2px solid #ccc;
			background-color: white;
		}
		#minimap {
			position: absolute;
			right: 20px;
			bottom: 20px;
			width: 200px;
			height: 200px;
			border: 2px solid #aaa;
			background-color: white;
			z-index: 10;
		}
	</style>
</head>
<body>
	<h1>üó∫Ô∏è Ecolia Realistic World</h1>

	<div class="controls">
		<button onclick="move('up')">‚¨ÜÔ∏è ÏúÑ</button>
		<button onclick="move('left')">‚¨ÖÔ∏è Ï¢å</button>
		<button onclick="move('right')">‚û°Ô∏è Ïö∞</button>
		<button onclick="move('down')">‚¨áÔ∏è ÏïÑÎûò</button>
	</div>

	<div class="map-container">
		<svg id="map" viewBox="0 0 640 640" preserveAspectRatio="xMidYMid meet"></svg>
		<canvas id="minimap" width="200" height="200"></canvas>
	</div>

	<script>
		const TILE_SIZE = 64;
		const VIEW_SIZE = 10;
		const MAX_BOUND = 2000;
		let originX = 0;
		let originY = 0;

		const svg = document.getElementById("map");
		const canvas = document.getElementById("minimap");
		const ctx = canvas.getContext("2d");

		function fetchAndRenderMap() {
			svg.innerHTML = "";
			fetch(`/api/map?x=${originX}&y=${originY}&size=${VIEW_SIZE}`)
				.then(res => res.json())
				.then(data => {
					const tiles = data.tiles;
					tiles.forEach((row, y) => {
						row.forEach((tile, x) => {
							const image = document.createElementNS("http://www.w3.org/2000/svg", "image");
							image.setAttribute("x", x * TILE_SIZE);
							image.setAttribute("y", y * TILE_SIZE);
							image.setAttribute("width", TILE_SIZE);
							image.setAttribute("height", TILE_SIZE);
							image.setAttributeNS("http://www.w3.org/1999/xlink", "href", `/static/tiles/${tile}.svg`);
							svg.appendChild(image);
						});
					});
				});
		}

		function renderMinimap() {
			fetch("/api/minimap")
				.then(res => res.json())
				.then(data => {
					if (!data || !data.minimap) return;
					const map = data.minimap;
					const cellSize = 2;
					ctx.clearRect(0, 0, canvas.width, canvas.height);
					map.forEach((row, y) => {
						row.forEach((color, x) => {
							ctx.fillStyle = color;
							ctx.fillRect(x * cellSize, y * cellSize, cellSize, cellSize);
						});
					});
					// ÌòÑÏû¨ ÏúÑÏπò ÌëúÏãú
					ctx.strokeStyle = "red";
					ctx.lineWidth = 1;
					ctx.strokeRect(
						(originX / 20) * cellSize,
						(originY / 20) * cellSize,
						(VIEW_SIZE / 20) * cellSize,
						(VIEW_SIZE / 20) * cellSize
					);
				});
		}

		function move(direction) {
			const delta = VIEW_SIZE;
			if (direction === "up") originY = Math.max(0, originY - delta);
			if (direction === "down") originY = Math.min(MAX_BOUND - VIEW_SIZE, originY + delta);
			if (direction === "left") originX = Math.max(0, originX - delta);
			if (direction === "right") originX = Math.min(MAX_BOUND - VIEW_SIZE, originX + delta);
			fetchAndRenderMap();
			renderMinimap();
		}

		document.addEventListener("keydown", (e) => {
			if (e.key === "ArrowUp") move("up");
			if (e.key === "ArrowDown") move("down");
			if (e.key === "ArrowLeft") move("left");
			if (e.key === "ArrowRight") move("right");
		});

		fetchAndRenderMap();
		renderMinimap();
	</script>
</body>
</html>
